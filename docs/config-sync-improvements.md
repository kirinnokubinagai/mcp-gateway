# MCP Gateway 設定管理システムの改善

## 概要

MCP Gatewayの設定管理システムを改善し、より効率的な差分検出と最小限の再接続を実現しました。

## 主な改善点

### 1. 設定ハッシュ値の改善

- **enabledフラグの除外**: プロファイルで制御されるenabledフラグをハッシュ計算から除外
- **確定的なJSON生成**: `JSON.stringify`に`null, 0`を指定し、常に同じ出力を保証
- **環境変数の展開前比較**: 環境変数は展開前の状態（`${ENV_VAR}`形式）で比較

### 2. Dockerイメージ名抽出の改善

- **包括的なオプション処理**: より多くのDockerオプションフラグを認識
- **--option=value形式のサポート**: 等号付きオプションも正しく処理
- **正確なイメージ名特定**: オプションをスキップして最初の非オプション引数を取得

### 3. 効率的な差分検出アルゴリズム

- **事前ハッシュ計算**: 設定のハッシュマップを事前に計算して高速化
- **名前変更の正確な検出**: ハッシュ値とDockerイメージ名の両方で比較
- **変更の分類**: 追加、削除、更新、再接続、変更なしを明確に分類

### 4. 最小限の再接続

- **名前変更時の接続維持**: 設定が同じ場合は既存の接続を移行
- **必要な場合のみ再接続**: ハッシュ値が変わった場合のみ再接続を実行
- **並列処理の最適化**: 切断→更新→新規接続の順序で効率的に実行

### 5. デバッグログの改善

- **構造化されたログ出力**: セクション分けされた見やすいログ
- **変更サマリーの表示**: 実行前に変更内容を明確に表示
- **タスク数の表示**: 実行されるタスクの総数を表示

## 実装の詳細

### calculateConfigHash関数

```typescript
function calculateConfigHash(config: ServerConfig): string {
  // enabledフラグは除外（プロファイルで制御されるため）
  const normalizedConfig = {
    command: config.command,
    args: config.args || [],
    env: config.env || {}
  };
  
  // ソートされたキーで確定的なJSON文字列を生成
  const configString = JSON.stringify(normalizedConfig, null, 0);
  return createHash('sha256').update(configString).digest('hex');
}
```

### extractDockerImageName関数

```typescript
function extractDockerImageName(args: string[]): string | null {
  // runコマンド以降で最初の非オプション引数を取得
  // 値を取るオプションを正確にスキップ
  const optionsWithValue = new Set([
    '--name', '--memory', '--cpus', '--network', '--user',
    '-e', '--env', '-v', '--volume', '--workdir', '-w',
    // ... その他のオプション
  ]);
  
  // オプションをスキップしてイメージ名を特定
}
```

### syncWithConfig関数の改善

1. **事前準備**
   - 設定のハッシュマップを作成
   - 現在の接続状態を分析

2. **名前変更検出**
   - 同じハッシュ値を持つサーバーを探索
   - Dockerの場合はイメージ名でも比較

3. **変更の分類と実行**
   - 削除、無効化、追加、更新、再接続を分類
   - 必要最小限のタスクのみ実行

## 効果

- **パフォーマンス向上**: 不要な再接続を削減
- **安定性向上**: 接続の中断を最小限に抑制
- **可視性向上**: 明確なログで状態変化を把握しやすく

## テスト結果

実装したテストスクリプトにより、以下の動作を確認：

- ✓ enabledフラグ変更時に再接続しない
- ✓ サーバー名変更を正確に検出
- ✓ Dockerイメージ名を正確に抽出
- ✓ 設定変更のみを検出して再接続

## 今後の拡張可能性

1. **接続プールの実装**: 一時的に古い接続を保持して切り替えを高速化
2. **段階的な移行**: 大規模な変更時に段階的に接続を切り替え
3. **ロールバック機能**: 接続失敗時に前の状態に戻す機能