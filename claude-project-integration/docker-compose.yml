# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
version: "3.8"

services:
  # === MCP Gateway çµ±åˆ ã“ã“ã‹ã‚‰ ===
  
  # 1. ãƒ—ãƒ­ã‚­ã‚·ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆæœ€åˆã«å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
  mcp-proxy-check:
    image: busybox
    command: |
      sh -c "
        if ! nc -z host.docker.internal 9999 2>/dev/null; then
          echo 'âŒ ã‚¨ãƒ©ãƒ¼: MCPãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ï¼'
          echo 'ğŸ‘‰ åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:'
          echo '   cd mcp-gateway && bun run proxy'
          exit 1
        fi
      "
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # 2. MCP Gateway APIã‚µãƒ¼ãƒãƒ¼
  mcp-gateway-server:
    build:
      context: ./mcp-gateway
      dockerfile: Dockerfile.server
    container_name: mcp-gateway-server
    ports:
      - "3003:3003"    # APIãƒãƒ¼ãƒˆ
    volumes:
      - ./mcp-gateway/mcp-config.json:/app/mcp-config.json
    environment:
      - MCP_PROXY_PORT=9999
      - DOCKER_ENV=true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mcp-proxy-check:
        condition: service_completed_successfully
    restart: unless-stopped

  # 3. MCPç®¡ç†ç”¨Web UIï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  mcp-gateway-client:
    build:
      context: ./mcp-gateway
      dockerfile: Dockerfile.client
    container_name: mcp-gateway-client
    ports:
      - "3002:3002"    # MCPç®¡ç†ç”¨Web UIãƒãƒ¼ãƒˆ
    environment:
      - API_URL=http://mcp-gateway-server:3003
    depends_on:
      - mcp-gateway-server
    restart: unless-stopped

  # === MCP Gateway çµ±åˆ ã“ã“ã¾ã§ ===

  # æ—¢å­˜ã®Claude Codeè¨­å®šã«è¿½åŠ 
  claude-code:
    extends:
      file: docker-compose-base.yml
      service: claude-code
    environment:
      # MCP Gateway APIã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
      - MCP_GATEWAY_URL=http://mcp-gateway-server:3003
    depends_on:
      - mcp-gateway-server
    # MCPã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã‚’Gatewayç”¨ã«æ›´æ–°
    volumes:
      # æ—¢å­˜ã®volumesã«è¿½åŠ 
      - ./docker-base/config/mcp-servers-gateway.json:/home/developer/.config/claude/mcp-servers.json:ro