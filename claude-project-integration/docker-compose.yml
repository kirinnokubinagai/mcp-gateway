# MCP Gatewayçµ±åˆç”¨ Docker Compose æ‹¡å¼µãƒ•ã‚¡ã‚¤ãƒ«
# docker-compose-base.ymlã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨
version: "3.8"

services:
  # ãƒ—ãƒ­ã‚­ã‚·ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆæœ€åˆã«å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
  mcp-proxy-check:
    image: busybox
    command: |
      sh -c "
        if ! nc -z host.docker.internal 9999 2>/dev/null; then
          echo 'âŒ ã‚¨ãƒ©ãƒ¼: MCPãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ï¼'
          echo 'ğŸ‘‰ åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:'
          echo '   cd mcp-gateway && bun run proxy'
          exit 1
        fi
      "
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # MCP Gateway APIã‚µãƒ¼ãƒãƒ¼
  mcp-gateway-server:
    build:
      context: ./mcp-gateway
      dockerfile: Dockerfile.server
    container_name: mcp-gateway-server
    ports:
      - "${MCP_API_PORT:-3003}:3003"
    volumes:
      - ./mcp-gateway/mcp-config.json:/app/mcp-config.json
    environment:
      - MCP_PROXY_PORT=${MCP_PROXY_PORT:-9999}
      - DOCKER_ENV=true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mcp-proxy-check:
        condition: service_completed_successfully
    restart: unless-stopped

  # MCPç®¡ç†ç”¨Web UIï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  mcp-gateway-client:
    build:
      context: ./mcp-gateway
      dockerfile: Dockerfile.client
    container_name: mcp-gateway-client
    ports:
      - "${MCP_WEB_PORT:-3002}:3002"
    environment:
      - API_URL=http://mcp-gateway-server:3003
    depends_on:
      - mcp-gateway-server
    restart: unless-stopped

  # Claude Codeã®æ‹¡å¼µè¨­å®š
  claude-code:
    environment:
      - MCP_GATEWAY_URL=http://mcp-gateway-server:3003
    depends_on:
      - mcp-gateway-server
    volumes:
      # MCPè¨­å®šã‚’Gatewayç”¨ã«æ›´æ–°ï¼ˆæ—¢å­˜ã®volumesã«è¿½åŠ ã•ã‚Œã‚‹ï¼‰
      - ./docker-base/config/mcp-servers-gateway.json:/home/developer/.config/claude/mcp-servers.json:ro